YUI.add("moodle-atto_edusharing-button",function(e,t){function i(e){this.name="",this.object_url="",this.course=e,this.id="",this.object_version="0"}var n="atto_edusharing",r='<div id="edusharing_hint"> <img src="" id="edusharing_hint_logo"><img id="edusharing_hint_help" src="'+M.cfg.wwwroot+'/lib/editor/atto/plugins/edusharing/pix/help_en.gif">'+'{{get_string "hint1" component}}<br/><br/>{{get_string "hint2" component}}'+'<div style="clear: both"></div>'+'<div id="edusharing_hint_skip"><input type="checkbox" id="edusharing_hint_check" name="edusharing_hint_check" value="dontshow" />'+'{{get_string "skipHint" component}}</div>'+'<div class="edusharing_center edusharing_hint_buttons"><a id="edusharing_hint_close" class="btn btn-secondary" href="#">'+'{{get_string "cancel" component}}</a> '+'<button id="edusharing_open_repo" class="btn btn-primary">{{get_string "openRepo" component}}</button></div>'+"</div> "+'<form id="edusharing_form" class="atto_form" style="display: none">'+'<input id="edusharing_object_url" name="edusharing_object_url" type="hidden" value="" />'+'<input id="edusharing_resid" name="edusharing_resid" type="hidden" value="" />'+'<input id="edusharing_mimetype" name="edusharing_mimetype" type="hidden" value="" />'+'<input id="edusharing_mediatype" name="edusharing_mediatype" type="hidden" value="" />'+'<input id="edusharing_preview_url" name="edusharing_preview_url" type="hidden" value="" />'+'<input id="edusharing_version" name="edusharing_version" type="hidden" value="" />'+'<input id="edusharing_ratio" name="edusharing_ratio" type="hidden" value="" />'+'<h2>{{get_string "title" component}}</h2>'+'<input id="edusharing_title" name="edusharing_title" value="" maxlength="25"/>'+'<i id="edusharing_title_pencil" class="icon fa fa-pencil fa-fw " aria-hidden="true"></i> '+'<span style="position:absolute; color: rgba(0, 0, 0, 0); display:inline-block; font-size:2em;"'+'id="edusharing_title_helper" name="edusharing_title_helper" value=""></span> '+'<img src="" id="edusharing_preview"> '+'<div id="edusharing_hint_directory" style="display:none">'+'{{get_string "directoryHint" component}}'+"</div>"+'<br/><input type="checkbox" id="edusharing_version_latest" name="edusharing_version_latest" checked />'+'<label for="edusharing_version_latest" class="edusharing_label_inline" id="edusharing_version_latest_label">'+'{{get_string "alwaysShowLatestVersion" component}}</label> '+'<div id="edusharing_wrapper_caption" class="edusharing_form_wrapper">'+'<h2>{{get_string "subtitle" component}}</h2> '+'<input id="edusharing_caption" name="edusharing_caption" value="" />'+"</div>"+'<div id="edusharing_wrapper_alignment" class="edusharing_form_wrapper">'+'<h2>{{get_string "alignment" component}}</h2> '+'<div class="edusharing_wrapper_alignment_radiowrapper">'+'<input type="radio" id="edusharing_alignment_left" name="edusharing_alignment" value="left">'+'<label for="edusharing_alignment_left" class="edusharing_label_inline">'+'{{get_string "alignmentLeft" component}}</label> '+"</div>"+'<div class="edusharing_wrapper_alignment_radiowrapper">'+'<input type="radio" id="edusharing_alignment_right" name="edusharing_alignment" value="right">'+'<label for="edusharing_alignment_right" class="edusharing_label_inline">'+'{{get_string "alignmentRight" component}}</label> '+"</div>"+'<div class="edusharing_wrapper_alignment_radiowrapper">'+'<input type="radio" id="edusharing_alignment_none" name="edusharing_alignment" value="none" checked="checked">'+'<label for="edusharing_alignment_none" class="edusharing_label_inline">'+'{{get_string "alignmentNone" component}}</label> '+"</div>"+"</div>"+'<div id="edusharing_wrapper_dimensions" class="edusharing_form_wrapper">'+'<h2>{{get_string "dimensions" component}}</h2>'+'<div style="float:left;margin-right: 20px;">'+'<label for="edusharing_width" class="edusharing_label_block">{{get_string "dimensionsWidth" component}}</label>'+'<input type="number" id="edusharing_width" name="edusharing_width" value="" maxlength="4" length="4" />&nbsp;px'+"</div>"+"<div>"+'<label for="edusharing_height" class="edusharing_label_block">{{get_string "dimensionsheight" component}}</label>'+'<input type="number" id="edusharing_height" name="edusharing_height" value="" maxlength="4" length="4"/>&nbsp;px'+"</div>"+"</div>"+'<div id="edusharing_wrapper_buttons" class="edusharing_form_wrapper">'+'<a id="edusharing_dialog_cancel" class="btn" href="#">{{get_string "cancel" component}}</a>'+'<button id="edusharing_submit" class="btn btn-primary">{{get_string "insert" component}}</button> '+"</div>"+"</form>";e.namespace("M.atto_edusharing").Button=e.Base.create("button",e.M.editor_atto.EditorPlugin,[],{initializer:function(){if(this.get("disabled"))return;this.addButton({icon:"icon",iconComponent:"atto_edusharing",buttonName:"icon",callback:this._displayDialogue,callbackArgs:"icon",tags:".edusharing_atto",tagMatchRequiresAll:!1});var e=this.get("host").textarea.ancestor("form");e&&e.on("submit",this.eduSubmit,this),this.getExistingObjects();var t=this;window.addEventListener("message",function(e){if(e.data.event=="APPLY_NODE"){var n=e.data.data;window.win.close(),t.updateDialog(n)}},!1)},getUrlVars:function(e){var t={};e.startsWith("?")||(e="?"+e);var n=e.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(e,n,r){t[n]=r});return t},getExistingObjects:function(){var t=this.get("host").textarea.get("value"),n=document.createElement("div");n.innerHTML=t;var r=[n];while(0<r.length){var s=r.shift();if(1==s.nodeType&&e.one(s).hasClass("edusharing_atto")){if(s.nodeName.toLowerCase()=="img")var o=s.getAttribute("src");else var o=s.getAttribute("href");var u=new URL(o);const a=u.searchParams;var f=new i(this.get("courseid"));f.importNode(a)?this.get("existingObjects")[f.id]=f:(alert("error_importing_node - 1"),s.parentNode.removeChild(s))}if(s.hasChildNodes()){child=0;while(child<s.childNodes.length)r.push(s.childNodes.item(child)),child++}}},updateDialog:function(t,r){e.one("#edusharing_form").set("style","display:block"
),e.one("#edusharing_hint").set("style","display:none");if(t.isDirectory)e.one("#edusharing_wrapper_dimensions").set("style","display:none"),e.one("#edusharing_version_latest").set("style","visibility:hidden"),e.one("#edusharing_version_latest_label").set("style","visibility:hidden"),e.one("#edusharing_wrapper_alignment").set("style","visibility:hidden"),e.one("#edusharing_hint_directory").set("style","display:block");else if(this.getType(t.mediatype)=="ref")e.one("#edusharing_wrapper_dimensions").set("style","visibility:hidden");else{var i=Math.round(t.properties["ccm:width"])||600,s=Math.round(t.properties["ccm:height"])||400;e.one("#edusharing_width").set("value",i),e.one("#edusharing_height").set("value",s),e.one("#edusharing_ratio").set("value",i/s)}e.one("#edusharing_title").set("value",t.title||t.name),e.one("#edusharing_caption").set("value",t.caption||""),e.one("#edusharing_object_url").set("value",t.objectUrl),e.one("#edusharing_mimetype").set("value",t.mimetype),e.one("#edusharing_mediatype").set("value",t.mediatype),e.one("#edusharing_preview_url").set("value",t.preview.url),e.one("#edusharing_preview").set("src",t.preview.url),e.one("#edusharing_version").set("value",t.properties["cclom:version"]),r&&(e.one("#edusharing_resid").set("value",t.resid),e.one("#edusharing_version_latest").set("style","display:none"),e.one("#edusharing_version_latest_label").set("style","display:none"),e.one("#edusharing_submit").setContent(M.util.get_string("update",n)),t.alignment?(e.one("#edusharing_alignment_none").set("checked",!1),e.one("#edusharing_alignment_"+t.alignment).set("checked",!0)):(e.one("#edusharing_alignment_none").set("checked",!0),e.one("#edusharing_alignment_right").set("checked",!1),e.one("#edusharing_alignment_left").set("checked",!1)))},eduSubmit:function(){var t=this.get("host").textarea.get("value"),n=document.createElement("div");n.innerHTML=t;var r=[n];while(0<r.length){var s=r.shift();if(s.nodeType==1&&e.one(s).hasClass("edusharing_atto")){if(s.nodeName.toLowerCase()=="img")var o=s.getAttribute("src");else var o=s.getAttribute("href");var u=new URL(o);const a=u.searchParams;var f=a.get("resourceId");if(f&&this.get("existingObjects")[f])delete this.get("existingObjects")[f];else{var l=new i(this.get("courseid"));l.importNode(a)||alert("error_importing_node - 2"),l.link(s)||(alert("error_setting_usage"),s.parentNode.removeChild(s)),s.nodeName.toLowerCase()=="img"?s.setAttribute("src",this.getPreviewUrl(l.id)+"&"+a.toString()):s.setAttribute("href",this.getPreviewUrl(l.id)+"&"+a.toString())}}if(s.hasChildNodes()){child=0;while(child<s.childNodes.length)r.push(s.childNodes.item(child)),child++}}for(var f in this.get("existingObjects")){var c=this.get("existingObjects")[f];c.unlink(s)||alert("error_deleting_usage")}this.get("host").textarea.set("value",n.innerHTML)},getQueryStringFromParams:function(e){var t=[];for(var n in e)t.push(n+"="+e[n]);return t.join("&")},getPreviewUrl:function(e){var t=M.cfg.wwwroot+"/lib/editor/atto/plugins/edusharing/preview.php";return t+="?resourceId="+e,t},getSelectedElement:function(){var t=this.get("host").getSelectedNodes()._nodes[0];return t&&t.nodeType&&t.nodeType==3&&(t=t.parentElement),typeof t=="undefined"?"":e.one(t).hasClass("edusharing_atto")?t:""},handleUpdate:function(){var e,t=[];e=this.getSelectedElement();if(e){if(e.nodeName.toLowerCase()=="img")var n=e.getAttribute("src");else var n=e.getAttribute("href");var r=new URL(n);const i=r.searchParams;return i.get("mediatype")=="folder"&&(t.isDirectory=!0),i.get("resourceId")&&(t.resid=i.get("resourceId")),t.title=i.get("title"),t.caption=i.get("caption"),t.properties=[],i.get("width")&&(t.properties["ccm:width"]=e.attributes.width.value),e.attributes.height&&(t.properties["ccm:height"]=e.attributes.height.value),t.objectUrl=i.get("object_url"),t.mimetype=i.get("mimetype"),t.mediatype=i.get("mediatype"),t.preview=[],this.getType(t.mediatype)=="content"?t.preview.url=e.attributes.src.value:t.preview.url=e.attributes.href.value,e.attributes.src?t.preview.url=e.attributes.src.value:t.preview.url=e.attributes.href.value,t.properties["cclom:version"]=i.get("window_version"),t.alignment=e.style.float,this.updateDialog(t,!0),!0}return!1},_displayDialogue:function(t,r){t.preventDefault();var i=800,s=600,o=this.getDialogue({headerContent:M.util.get_string("dialogtitle",n),width:i+"px",height:s+"px",focusAfterHide:r});o.width!==i+"px"&&o.set("width",i+"px");var u=this._getFormContent(r),a=e.Node.create("<div></div>");a.append(u),o.set("bodyContent",a);var f=this.handleUpdate();if(!f){e.one("#edusharing_hint_logo").setAttribute("src",this.get("repourl")+"/assets/images/logo.svg");var l=this;YUI().use("cookie",function(e){e.Cookie.get("edusharing_hint_hide")?(l.open_repo(),YUI().use("node",function(e){e.one("#edusharing_hint_check").setAttribute("checked","checked")})):YUI().use("node",function(e){e.one("#edusharing_hint_check").removeAttribute("checked")})})}o.show(),this.markUpdated()},_getFormContent:function(t){var i=e.Handlebars.compile(r),s=e.Node.create(i({component:n,clickedicon:t}));return this._form=s,this._form.one("#edusharing_submit").on("click",this._doInsert,this),this._form.one("#edusharing_hint_check").setAttribute("checked","checked"),this._form.one("#edusharing_hint_check").on("change",this.edusharing_hint_check_change,this),this._form.one("#edusharing_open_repo").on("click",this.open_repo,this),this._form.one("#edusharing_hint_close").on("click",this.closeDialog,this),this._form.one("#edusharing_dialog_cancel").on("click",this.closeDialog,this),this._form.one("#edusharing_width").on("change",this.recalculateDimensions,this),this._form.one("#edusharing_width").on("keyup",this.recalculateDimensions,this),this._form.one("#edusharing_height").on("change",this.recalculateDimensions,this),this._form.one("#edusharing_height").on("keyup",this.recalculateDimensions,this),this._form.one("#edusharing_title").on("keyup",this.recalculateTitleWidth,this),s},recalculateTitleWidth:function(
){e.one("#edusharing_title_helper").setContent(e.one("#edusharing_title").get("value")),e.one("#edusharing_title").setStyle("width",e.one("#edusharing_title_helper").get("offsetWidth")+10+"px")},closeDialog:function(e){e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide()},open_repo:function(){var e=this.get("repourl")+"/components/search?reurl=WINDOW&applyDirectories=true&ticket="+this.get("ticket");window.win=window.open(e)},recalculateDimensions:function(t){t._currentTarget.id=="edusharing_height"?e.one("#edusharing_width").set("value",Math.round(e.one("#edusharing_height").get("value")*e.one("#edusharing_ratio").get("value"))):e.one("#edusharing_height").set("value",Math.round(e.one("#edusharing_width").get("value")/e.one("#edusharing_ratio").get("value")))},edusharing_hint_check_change:function(e){YUI().use("cookie",function(t){e.target._stateProxy.checked?t.Cookie.set("edusharing_hint_hide",!0,{expires:new Date("January 12, 2025")}):t.Cookie.remove("edusharing_hint_hide")})},_doInsert:function(e){e.preventDefault(),this.getDialogue({focusAfterHide:null}).hide(),this.editor.focus();var t=this.getNode();if(t.resid){var n=this.getSelectedElement();n.setAttribute("title",t.title);var r="";t.alignment!="none"&&(r="float:"+t.alignment),t.mediatype=="folder"&&(r="display:block;"),n.setAttribute("style",r);if(this.getType(t.mediatype)=="ref"){const i=new URL(n.attributes.href.value);n.innerHTML=t.title,i.searchParams.set("title",t.title),i.searchParams.set("caption",t.caption),n.setAttribute("href",i.toString())}else{const i=new URL(n.attributes.src.value);i.searchParams.set("title",t.title),i.searchParams.set("caption",t.caption),i.searchParams.set("width",t.width),i.searchParams.set("height",t.height),n.setAttribute("alt",t.title),n.setAttribute("width",t.width),n.setAttribute("height",t.height),n.setAttribute("src",i.toString())}}else{var r="";t.alignment!="none"&&(r="float:"+t.alignment+";"),t.mediatype=="folder"&&(r="display:block;");var s="0";0==t.showlatest&&t.version!="undefined"&&(s=t.version);var o='class="edusharing_atto" style="'+r+'" '+'title="'+t.title+'" '+'contenteditable="false" ',i=t.previewurl+"&caption="+t.caption+"&object_url="+t.objecturl+"&mediatype="+t.mediatype+"&mimetype="+t.mimetype+"&window_version="+s+"&title="+t.title,i=new URL(t.previewurl);i.searchParams.set("caption",t.caption),i.searchParams.set("object_url",t.objecturl),i.searchParams.set("mediatype",t.mediatype),i.searchParams.set("mimetype",t.mimetype),i.searchParams.set("window_version",s),i.searchParams.set("title",t.title),t.type=="ref"?o="&nbsp;<a "+o+' href="'+i.toString()+'">'+t.title+"</a>&nbsp;":(o+='src="'+i.toString()+"&width="+t.width+"&height="+t.height+'"',o='<img alt="'+t.title+'" width="'+t.width+'" height="'+t.height+'" '+o+" />"),this.get("host").insertContentAtFocusPoint(o)}this.markUpdated()},getType:function(e){var t="ref";switch(!0){case e.indexOf("image")>-1:case e.indexOf("video")>-1:case e.indexOf("h5p")>-1:case e.indexOf("learningapps")>-1:case e.indexOf("youtube")>-1:case e.indexOf("vimeo")>-1:case e.indexOf("folder")>-1:t="content"}return t},getNode:function(){var t={};return t.resid=e.one("#edusharing_resid").get("value"),t.title=e.one("#edusharing_title").get("value"),t.caption=e.one("#edusharing_caption").get("value"),t.width=e.one("#edusharing_width").get("value"),t.height=e.one("#edusharing_height").get("value"),t.previewurl=e.one("#edusharing_preview_url").get("value"),t.objecturl=e.one("#edusharing_object_url").get("value"),t.mimetype=e.one("#edusharing_mimetype").get("value"),t.mediatype=e.one("#edusharing_mediatype").get("value"),t.showlatest=e.one("#edusharing_version_latest").get("checked"),t.version=e.one("#edusharing_version").get("value"),t.version=="undefined"&&(t.version="0"),t.alignment=e.one("input[name=edusharing_alignment]:checked").get("value"),t.type=this.getType(t.mediatype),t.mediatype=="folder"&&(t.showlatest=!0,t.width=500),t}},{ATTRS:{disabled:{value:!1},repourl:{value:""},courseid:{value:""},ticket:{value:""},existingObjects:{value:[]}}}),i.prototype.importNode=function(t){var n=t.get("title");if(!n)return!1;this.name=n;var r=t.get("object_url");if(!r)return!1;this.object_url=r;var i=t.get("resourceId");i&&(this.id=i);var s=t.get("window_version");return s&&(this.object_version=s),!0},i.prototype.link=function(t){var n=M.cfg.wwwroot+"/lib/editor/atto/plugins/edusharing/insert.php?sesskey="+M.cfg.sesskey,r=this,i=YUI().use("io","json"),s={method:"POST",sync:!0,data:i.JSON.stringify(r),arguments:{},on:{success:function(e,t,n){try{var s=i.JSON.parse(t.responseText)}catch(o){return alert("invalid data"),!1}return s.id?(r.id=s.id,!0):(alert("no resource id"),!1)},failure:function(e,t,n){return alert("error setting usage"),!1}}};return i.io(n,s)},i.prototype.unlink=function(t){var n=M.cfg.wwwroot+"/lib/editor/atto/plugins/edusharing/delete.php?sesskey="+M.cfg.sesskey,r=this,i=YUI().use("io","json","json-stringify"),s={method:"POST",sync:!0,headers:{"Content-Type":"application/json"},data:i.JSON.stringify(r),arguments:{object:r,node:t},on:{success:function(e,t,n){return!0},failure:function(e,t,n){return alert("error deleting object "+r.id+"."),!1}}};return i.io(n,s)}},"@VERSION@",{requires:["moodle-editor_atto-plugin"]});
